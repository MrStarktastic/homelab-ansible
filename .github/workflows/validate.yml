---
name: Validate Ansible playbook
on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'renovate.json'

jobs:
  lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Cache Pip Packages
        uses: actions/cache@v5.0.1
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install ansible-lint
        run: pip install ansible-lint

      - name: Run ansible-lint
        id: lint
        run: |
          set +e

          ansible-lint --offline --nocolor . > lint.log 2>&1
          EXIT_CODE=$?

          echo "$EXIT_CODE" > lint.exitcode
          cat lint.log

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ansible-lint-results
          path: |
            lint.log
            lint.exitcode

  syntax-check:
    name: Ansible Syntax Check
    runs-on: self-hosted
    container:
      image: python:slim
    steps:
      - uses: actions/checkout@v6

      - name: Install Ansible and requirements
        run: pip install -r requirements.txt

      - name: Setup SSH Key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > private_key.pem
          chmod 400 private_key.pem

      - name: Create Ansible Vault password file
        run: echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_pass

      - name: Run Ansible Syntax Check
        env:
          PROXMOX_URL: ${{ secrets.PROXMOX_URL }}
          PROXMOX_USER: ${{ secrets.PROXMOX_USER }}
          PROXMOX_TOKEN_ID: ${{ secrets.PROXMOX_TOKEN_ID }}
          PROXMOX_TOKEN_SECRET: ${{ secrets.PROXMOX_TOKEN_SECRET }}
        run: |
          set +e

          ansible-playbook -i inventory/proxmox.yml \
            --vault-password-file .vault_pass \
            --private-key private_key.pem --syntax-check \
            k3s.yml > syntax.log 2>&1
          EXIT_CODE=$?
          
          echo "$EXIT_CODE" > syntax.exitcode
          cat syntax.log

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ansible-syntax-results
          path: |
            syntax.log
            syntax.exitcode

  comment:
    if: always()
    name: Report Results
    runs-on: ubuntu-latest
    needs: [lint, syntax-check]
    permissions:
      pull-requests: write
    steps:
      - name: Download Lint Results
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: ansible-lint-results

      - name: Download Syntax Results
        uses: actions/download-artifact@v7
        continue-on-error: true
        with:
          name: ansible-syntax-results

      - name: Construct and Post Comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -f "lint.exitcode" ]; then
            LINT_CODE=$(cat lint.exitcode)
            LINT_LOG=$(cat lint.log)
            if [ "$LINT_CODE" -eq "0" ]; then
               LINT_ICON="‚úÖ Passed"
            else
               LINT_ICON="‚ùå Failed"
            fi
          else
            LINT_CODE=1
            LINT_ICON="‚ö†Ô∏è Skipped / Crashed"
            LINT_LOG="No log available. The job likely failed before generating artifacts."
          fi

          if [ -f "syntax.exitcode" ]; then
            SYNTAX_CODE=$(cat syntax.exitcode)
            SYNTAX_LOG=$(cat syntax.log)
            if [ "$SYNTAX_CODE" -eq "0" ]; then
               SYNTAX_ICON="‚úÖ Passed"
            else
               SYNTAX_ICON="‚ùå Failed"
            fi
          else
            SYNTAX_CODE=1
            SYNTAX_ICON="‚ö†Ô∏è Skipped / Crashed"
            SYNTAX_LOG="No log available."
          fi

          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          
          cat << $EOF > comment_body.md
          ## ü§ñ Ansible Validation Report

          | Check | Status |
          | :--- | :--- |
          | **Ansible Lint** | $LINT_ICON |
          | **Syntax Check** | $SYNTAX_ICON |

          <details>
          <summary>üîç <strong>Lint Details</strong></summary>

          \`\`\`text
          $LINT_LOG
          \`\`\`
          </details>

          <details>
          <summary>üõ†Ô∏è <strong>Syntax Details</strong></summary>

          \`\`\`text
          $SYNTAX_LOG
          \`\`\`
          </details>
          $EOF

          gh pr comment ${{ github.event.pull_request.number }} \
            -R ${{ github.repository }} \
            --body-file comment_body.md

          if [ "$LINT_CODE" -ne "0" ] || [ "$SYNTAX_CODE" -ne "0" ]; then
            echo "::error::Validation checks failed or were skipped."
            exit 1
          else
            echo "All checks passed."
            exit 0
          fi
