---
name: Validate Ansible playbook
on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'renovate.json'

jobs:
  lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install ansible-lint
        run: pip install ansible-lint

      - name: Run ansible-lint
        id: lint
        run: |
          set +e

          ansible-lint --offline --nocolor . > lint.log 2>&1
          EXIT_CODE=$?

          echo "$EXIT_CODE" > lint.exitcode
          cat lint.log

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ansible-lint-results
          path: |
            lint.log
            lint.exitcode

  syntax-check:
    name: Ansible Syntax Check
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v6

      # Apparently the setup-python action is not compatible with Debian
      # so I installed pipx manually
      - name: Install Ansible
        run: |
          pipx install --include-deps ansible
          pipx inject ansible requests kubernetes
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Setup SSH Key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > private_key.pem
          chmod 400 private_key.pem

      - name: Run Ansible Syntax Check
        env:
          PROXMOX_URL: ${{ secrets.PROXMOX_URL }}
          PROXMOX_USER: ${{ secrets.PROXMOX_USER }}
          PROXMOX_TOKEN_ID: ${{ secrets.PROXMOX_TOKEN_ID }}
          PROXMOX_TOKEN_SECRET: ${{ secrets.PROXMOX_TOKEN_SECRET }}
        run: |
          set +e

          ansible-playbook -i inventory/proxmox.yml \
            --private-key private_key.pem --syntax-check \
            k3s.yml > syntax.log 2>&1
          EXIT_CODE=$?
          
          echo "$EXIT_CODE" > syntax.exitcode
          cat syntax.log

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ansible-syntax-results
          path: |
            syntax.log
            syntax.exitcode

  comment:
    if: always()
    name: Report Results
    runs-on: ubuntu-latest
    needs: [lint, syntax-check]
    permissions:
      pull-requests: write
    steps:
      - name: Download Lint Results
        uses: actions/download-artifact@v4
        with:
          name: ansible-lint-results

      - name: Download Syntax Results
        uses: actions/download-artifact@v4
        with:
          name: ansible-syntax-results

      - name: Construct and Post Comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LINT_EXIT_CODE=$(cat lint.exitcode)
          SYNTAX_EXIT_CODE=$(cat syntax.exitcode)

          LINT_LOG=$(cat lint.log)
          SYNTAX_LOG=$(cat syntax.log)

          if [ "$LINT_EXIT_CODE" -eq "0" ]; then LINT_ICON="‚úÖ Passed"; else LINT_ICON="‚ùå Failed"; fi
          if [ "$SYNTAX_EXIT_CODE" -eq "0" ]; then SYNTAX_ICON="‚úÖ Passed"; else SYNTAX_ICON="‚ùå Failed"; fi

          # Using delimiter to handle multiline content safely
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          
          cat << $EOF > comment_body.md
          ## ü§ñ Ansible Validation Report

          | Check | Status |
          | :--- | :--- |
          | **Ansible Lint** | $LINT_ICON |
          | **Syntax Check** | $SYNTAX_ICON |

          <details>
          <summary>üîç <strong>Lint Details</strong></summary>

          \`\`\`text
          $LINT_LOG
          \`\`\`
          </details>

          <details>
          <summary>üõ†Ô∏è <strong>Syntax Details</strong></summary>

          \`\`\`text
          $SYNTAX_LOG
          \`\`\`
          </details>
          $EOF

          # Post Comment
          gh pr comment ${{ github.event.pull_request.number }} \
            -R ${{ github.repository }} \
            --body-file comment_body.md

          if [ "$LINT_EXIT_CODE" -ne "0" ] || [ "$SYNTAX_EXIT_CODE" -ne "0" ]; then
            echo "::error::Validation checks failed."
            exit 1
          else
            echo "All checks passed."
            exit 0
          fi
