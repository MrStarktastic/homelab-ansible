---
- name: Read cloud-init ENI file
  ansible.builtin.stat:
    path: /etc/network/interfaces.d/50-cloud-init
  register: dns_from_cloudinit_eni

- name: Extract nameservers from 'lo' stanza in ENI
  ansible.builtin.shell: |
    set -o pipefail
    awk '
      $0 ~ /^iface[[:space:]]+lo[[:space:]]+inet/ { inlo=1; next }
      $0 ~ /^iface[[:space:]]+/ { inlo=0 }
      inlo && $1=="dns-nameservers" { for (i=2;i<=NF;i++) print $i }
    ' /etc/network/interfaces.d/50-cloud-init | tr '\n' ' '
  register: dns_from_cloudinit_lo_ns
  changed_when: false
  when: dns_from_cloudinit_eni.stat.exists

- name: Set nameservers variable
  ansible.builtin.set_fact:
    dns_from_cloudinit_dns_nameservers: >-
      {{ dns_from_cloudinit_lo_ns.stdout.split()
      if (dns_from_cloudinit_eni.stat.exists and (dns_from_cloudinit_lo_ns.stdout | trim) != '')
      else [] }}

- name: Fallback to default gateway if no nameservers found
  ansible.builtin.shell: |
    set -o pipefail
    ip -4 route show default | awk '{print $3}' | head -n1
  register: dns_from_cloudinit_gw
  changed_when: false
  when: dns_from_cloudinit_dns_nameservers | length == 0

- name: Set nameservers variable to default gateway
  ansible.builtin.set_fact:
    dns_from_cloudinit_dns_nameservers: ["{{ dns_from_cloudinit_gw.stdout }}"]
  when: >-
    dns_from_cloudinit_dns_nameservers |
    length == 0 and (dns_from_cloudinit_gw.stdout | trim) != ""

- name: Assert that we have at least one nameserver
  ansible.builtin.assert:
    that: dns_from_cloudinit_dns_nameservers | length > 0
    fail_msg: "No DNS nameserver found."
    success_msg: >-
      Using DNS servers: {{ dns_from_cloudinit_dns_nameservers | join(', ') }}

- name: Write /etc/resolv.conf from effective values
  ansible.builtin.template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf
    mode: "0644"
