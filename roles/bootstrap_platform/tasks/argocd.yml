- name: Create ArgoCD namespace
  kubernetes.core.k8s:
    api_version: v1
    name: argocd
    kind: Namespace

- name: Add ArgoCD helm repo
  kubernetes.core.helm_repository:
    name: argo
    repo_url: "https://argoproj.github.io/argo-helm"

- name: Install ArgoCD
  kubernetes.core.helm:
    name: argocd
    chart_ref: argo/argo-cd
    release_namespace: argocd
    # renovate: datasource=helm depName=argo-cd registryUrl=https://argoproj.github.io/argo-helm
    chart_version: "9.2.0"
    update_repo_cache: true
    values:
      controller:
        replicas: 1
      server:
        replicas: 1
      repoServer:
        replicas: 1
      applicationSet:
        replicas: 1
      redis:
        enabled: true
      configs:
        secret:
          argocdServerAdminPassword: "{{ argocd_admin_password_hash }}"
          extra:
            oidc.authentik.clientID: "{{ argocd_oidc_client_id }}"
            oidc.authentik.clientSecret: "{{ argocd_oidc_client_secret }}"
        cm:
          url: "https://argocd.internal.starktastic.net"
          oidc.config: |
            name: Authentik
            issuer: "https://auth.starktastic.net/application/o/argo-cd/"
            clientID: "$oidc.authentik.clientID"
            clientSecret: "$oidc.authentik.clientSecret"
            requestedScopes: ["openid", "profile", "email", "groups"]
        rbac:
          policy.default: role:readonly
          scopes: "[groups]"
          policy.csv: |
            g, authentik Admins, role:admin

- name: Wait for ArgoCD server to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: argocd
    label_selectors:
      - "app.kubernetes.io/part-of=argocd"
  register: argocd_pods
  until: >
    argocd_pods.resources | length > 0 and
    argocd_pods.resources | map(attribute='status.availableReplicas') | select('defined') | list | length == argocd_pods.resources | length
  retries: 30
  delay: 10

- name: Apply app of apps bootstrap
  kubernetes.core.k8s:
    definition:
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: cluster-bootstrap
        namespace: argocd
        finalizers: ["resources-finalizer.argocd.argoproj.io"]
      spec:
        project: default
        source:
          repoURL: "{{ argocd_repo_url }}"
          targetRevision: HEAD
          path: apps/bootstrap
        destination:
          server: https://kubernetes.default.svc
          namespace: argocd
        syncPolicy:
          automated:
            prune: true
            selfHeal: true
