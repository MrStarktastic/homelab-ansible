- name: Create ArgoCD namespace
  kubernetes.core.k8s:
    api_version: v1
    name: argocd
    kind: Namespace

- name: Add ArgoCD helm repo
  kubernetes.core.helm_repository:
    name: argo
    repo_url: "https://argoproj.github.io/argo-helm"

- name: Install ArgoCD
  kubernetes.core.helm:
    name: argocd
    chart_ref: argo/argo-cd
    release_namespace: argocd
    update_repo_cache: true
    chart_version: "9.1.6" 
    values:
      controller:
        replicas: 1
      server:
        replicas: 1
      repoServer:
        replicas: 1
      applicationSet:
        replicas: 1
      redis:
        enabled: true

- name: Wait for ArgoCD server to start
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: argocd
    name: argocd-server
  register: argocd_deployment
  until: argocd_deployment.resources[0].status.availableReplicas is defined and argocd_deployment.resources[0].status.availableReplicas > 0
  retries: 20
  delay: 15
