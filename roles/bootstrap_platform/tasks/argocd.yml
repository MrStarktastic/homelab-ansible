- name: Create ArgoCD namespace
  kubernetes.core.k8s:
    api_version: v1
    name: argocd
    kind: Namespace

- name: Add ArgoCD helm repo
  kubernetes.core.helm_repository:
    name: argo
    repo_url: "https://argoproj.github.io/argo-helm"

- name: Install ArgoCD
  kubernetes.core.helm:
    name: argocd
    chart_ref: argo/argo-cd
    release_namespace: argocd
    # renovate: datasource=helm depName=argo-cd registryUrl=https://argoproj.github.io/argo-helm
    chart_version: "9.1.6"
    update_repo_cache: true
    values:
      controller:
        replicas: 1
      server:
        replicas: 1
      repoServer:
        replicas: 1
      applicationSet:
        replicas: 1
      redis:
        enabled: true
      configs:
        secret:
          argocdServerAdminPassword: "{{ argocd_admin_password_hash }}"

- name: Wait for ArgoCD server to start
  kubernetes.core.k8s_info:
    kind: Deployment
    namespace: argocd
    name: argocd-server
  register: argocd_deployment
  until: argocd_deployment.resources[0].status.availableReplicas is defined and argocd_deployment.resources[0].status.availableReplicas > 0
  retries: 20
  delay: 15

- name: Apply infrastructure controllers
  kubernetes.core.k8s:
    definition:
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: infrastructure-controllers
        namespace: argocd
      spec:
        project: default
        source:
          repoURL: "{{ argocd_repo_url }}"
          targetRevision: HEAD
          path: apps/infrastructure/controllers
          directory:
            recurse: true
        destination:
          server: https://kubernetes.default.svc
          namespace: argocd
        syncPolicy:
          automated:
            prune: true
            selfHeal: true
          retry:
            limit: 5
            backoff:
              duration: 5s
              factor: 2
              maxDuration: 3m
          syncOptions:
            - CreateNamespace=true

- name: Wait for Cert-Manager CRDs
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: certificates.cert-manager.io
  register: crd_check
  until: crd_check.resources | length > 0
  retries: 30
  delay: 10

- name: Wait for Sealed-Secrets CRDs
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: sealedsecrets.bitnami.com
  register: ss_crd_check
  until: ss_crd_check.resources | length > 0
  retries: 30
  delay: 10

- name: Wait for Traefik CRDs
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: ingressroutes.traefik.io
  register: traefik_crd_check
  until: traefik_crd_check.resources | length > 0
  retries: 30
  delay: 10

- name: Apply infrastructure configs
  kubernetes.core.k8s:
    definition:
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: infrastructure-configs
        namespace: argocd
      spec:
        project: default
        source:
          repoURL: "{{ argocd_repo_url }}"
          targetRevision: HEAD
          path: apps/infrastructure/configs
          directory:
            recurse: true
        destination:
          server: https://kubernetes.default.svc
          namespace: default 
        syncPolicy:
          automated:
            prune: true
            selfHeal: true
          retry:
            limit: 5
            backoff:
              duration: 5s
              factor: 2
              maxDuration: 3m
          syncOptions:
            - CreateNamespace=true

# - name: Apply services
#   kubernetes.core.k8s:
#     definition:
#       apiVersion: argoproj.io/v1alpha1
#       kind: Application
#       metadata:
#         name: services-root
#         namespace: argocd
#       spec:
#         project: default
#         source:
#           repoURL: "{{ argocd_repo_url }}"
#           targetRevision: HEAD
#           path: apps/services
#           directory:
#             recurse: true
#         destination:
#           server: https://kubernetes.default.svc
#           namespace: argocd
#         syncPolicy:
#           automated:
#             prune: true
#             selfHeal: true
#           retry:
#             limit: 5
#             backoff:
#               duration: 5s
#               factor: 2
#               maxDuration: 3m
#           syncOptions:
#             - CreateNamespace=true
